<!DOCTYPE html>
<html lang="en">
<head>
    <title>Nucantus | Song Challenge</title>
    <meta charset="UTF-8"/>
    <script src="//code.jquery.com/jquery-3.2.0.min.js"
            integrity="sha384-o9KO9jVK1Q4ybtHgJCCHfgQrTRNlkT6SL3j/qMuBMlDw3MmFrgrOHCOaIMJWGgK5"
            crossorigin="anonymous"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>
    <script src="//cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"
            integrity="sha384-BpOQ55RA3arDUEP5boNauNeeKbuCH9IAzxHZTwHM+BKw2N09+Wep2yWWyvnE5eZl"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdn.datatables.net/1.10.13/css/jquery.dataTables.min.css"
          integrity="sha384-YcTv91pbdpZ4It88TK5bVHIGTuPqoSi0CpPF9UA9eRicGHEJ3lpQZajpytN4rLkp" crossorigin="anonymous">
    <script src="config.js"></script>
    <link rel="stylesheet" type="text/css" href="nucantus.css"/>
    <script>
        "use strict";
        let openChallenges;
        // TODO add favicon.ico
        // TODO test mobile friendliness

        jQuery(() => {
            jQuery.ajax({url: baseURI + "open", crossDomain: true}).done(data => {
                openChallenges = data;
                jQuery.ajax({url: "songs.txt"}).done(handleSongs);
            });

            jQuery("#submit").click(() => { // handle challenge or join request on button click
                let song = jQuery("#song").text().trim();
                let name = jQuery("#name").val().trim();

                if (name.length > 1) { // input validation
                    let action = jQuery("#submit").text().toLowerCase();
                    jQuery.ajax({
                        url: baseURI + action, // challenge or join
                        type: "POST",
                        crossDomain: true,
                        data: {
                            song: song,
                            player: name
                        }
                    }).always(() => {
                        jQuery("#challenge-dialog").modal("hide");
                        location.reload(); // TODO alternatively update button only depending on server response status
                    });
                } else {
                    alert("Provided name is invalid.");
                }
            });

            jQuery("#name").keydown(event => { // trigger submit click on enter key press
                let keyCode = (event.keyCode ? event.keyCode : event.which);
                if (keyCode == 13) {
                    jQuery("#submit").click();
                }
            });
        });

        /**
         * Add row to table for each song.
         * @param data {string} newline-separated song list
         */
        function handleSongs(data) {
            for (let song of data.split("\n")) {
                if (song.length < 5) continue;
                let row = jQuery("<tr/>").appendTo("#songs tbody");
                jQuery("<td/>").appendTo(row).html(song.split(" - ")[0]);
                jQuery("<td/>").appendTo(row).html(song.split(" - ")[1]);

                // build and assign challenge button
                let button = jQuery("<button/>");
                button.attr("type", "button").addClass("btn btn-xs");

                let challenged = false;
                for (let openChallenge of openChallenges) {
                    if (openChallenge.song === song.trim()) {
                        challenged = true;
                        break; // TODO remove this challenge from open list (performance)
                    }
                }
                if (challenged)
                    button.addClass("btn-success").text("Join");
                else
                    button.addClass("btn-primary").text("Challenge");

                // configure and show challenge dialog
                button.click(() => {
                    jQuery("#song").text(song);
                    if (challenged)
                        jQuery("#submit").text("Join");
                    else jQuery("#submit").text("Challenge");
                    jQuery("#challenge-dialog").modal("show");
                    window.setTimeout(() => {
                        jQuery("#name").focus();
                    }, 500);
                });
                jQuery("<td/>").append(button).appendTo(row);
            }
            jQuery('#songs').DataTable({paging: false, order: [[2, "desc"], [0, "asc"]]});
        }
    </script>
</head>

<body>
<h1>Select Song to Challenge or Join</h1>

<table id="songs" class="table table-hover table-striped">
    <thead>
    <tr>
        <th>Artist</th>
        <th>Title</th>
        <th>Challenge</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- modal dialog for challenge or join action, being capable of taking player name text input -->
<div class="modal fade" id="challenge-dialog" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="challenge-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="song"></h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="name">Player name</label>
                    <input type="email" class="form-control" id="name" placeholder="Type in your name ...">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="submit">Challenge</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>